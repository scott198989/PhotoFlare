<div class="pf-messages-page">
  <div class="pf-messages-container">
    <%# Sidebar with conversation list %>
    <aside class="pf-messages-sidebar">
      <div class="pf-messages-header">
        <h1><%= current_user.username %></h1>
        <button type="button" class="pf-messages-new-btn" title="New Message">
          <i class="fa-regular fa-pen-to-square"></i>
        </button>
      </div>

      <div class="pf-messages-tabs">
        <button type="button" class="pf-messages-tab active">Messages</button>
        <button type="button" class="pf-messages-tab">Requests</button>
      </div>

      <div class="pf-conversations-list">
        <% if @conversations.any? %>
          <% @conversations.each do |conversation| %>
            <% other_user = conversation.other_participant(current_user) %>
            <% last_message = conversation.last_message %>
            <% unread_count = conversation.unread_count_for(current_user) %>

            <%= link_to conversation_path(conversation), class: "pf-conversation-item #{'unread' if unread_count > 0}" do %>
              <div class="pf-conversation-avatar">
                <% if other_user.profile_pic.attached? %>
                  <%= image_tag other_user.profile_pic, class: "pf-avatar pf-avatar-lg" %>
                <% else %>
                  <%= image_tag 'user-pp.png', class: "pf-avatar pf-avatar-lg" %>
                <% end %>
                <% if other_user.has_active_story? %>
                  <span class="pf-story-indicator"></span>
                <% end %>
              </div>
              <div class="pf-conversation-info">
                <span class="pf-conversation-name"><%= other_user.username %></span>
                <% if last_message %>
                  <span class="pf-conversation-preview">
                    <% if last_message.sender == current_user %>You: <% end %>
                    <%= truncate(last_message.body || 'Sent an attachment', length: 30) %>
                    <span class="pf-conversation-time"> Â· <%= time_ago_in_words(last_message.created_at) %></span>
                  </span>
                <% end %>
              </div>
              <% if unread_count > 0 %>
                <span class="pf-unread-badge"><%= unread_count > 9 ? '9+' : unread_count %></span>
              <% end %>
            <% end %>
          <% end %>
        <% else %>
          <div class="pf-messages-empty">
            <div class="pf-empty-icon">
              <i class="fa-regular fa-paper-plane"></i>
            </div>
            <h3>Your messages</h3>
            <p>Send private photos and messages to a friend or group.</p>
            <button type="button" class="pf-btn pf-btn-primary">Send Message</button>
          </div>
        <% end %>
      </div>
    </aside>

    <%# Empty state for main area %>
    <main class="pf-messages-main pf-messages-empty-main">
      <div class="pf-empty-icon">
        <i class="fa-regular fa-paper-plane"></i>
      </div>
      <h2>Your messages</h2>
      <p>Send private photos and messages to a friend or group.</p>
      <button type="button" class="pf-btn pf-btn-primary">Send Message</button>
    </main>
  </div>
</div>
