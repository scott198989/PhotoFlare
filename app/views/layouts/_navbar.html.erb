<nav class="pf-navbar">
  <div class="pf-navbar-container">
    <%# Logo %>
    <%= link_to root_path, class: "pf-navbar-logo" do %>
      <span class="pf-logo-text">PhotoFlare</span>
    <% end %>

    <%# Search %>
    <div class="pf-navbar-search" data-controller="search">
      <%= form_with(url: users_path, method: :get, data: { turbo_frame: "search_results" }, class: "pf-search-form") do |f| %>
        <i class="fa-solid fa-magnifying-glass pf-search-icon"></i>
        <%= f.text_field :search_query,
            class: "pf-search-input",
            type: "search",
            placeholder: "Search",
            autocomplete: "off",
            data: {
              action: "input->search#search focus->search#showResults blur->search#hideResults",
              search_target: "input"
            } %>
        <div class="pf-search-results" data-search-target="results">
          <%= render 'layouts/search_results', users: [] %>
        </div>
      <% end %>
    </div>

    <%# Navigation Icons %>
    <div class="pf-navbar-nav">
      <%# Home %>
      <%= link_to root_path, class: "pf-nav-item #{'active' if current_page?(root_path)}", title: "Home" do %>
        <i class="fa-solid fa-house"></i>
      <% end %>

      <%# Messages - only show if conversations table exists %>
      <% if ActiveRecord::Base.connection.table_exists?(:conversations) rescue false %>
        <%= link_to conversations_path, class: "pf-nav-item #{'active' if controller_name == 'conversations'}", title: "Messages" do %>
          <i class="fa-regular fa-paper-plane"></i>
        <% end %>
      <% end %>

      <%# Create Post %>
      <button type="button" class="pf-nav-item" data-bs-toggle="modal" data-bs-target="#staticBackdrop" title="Create Post">
        <i class="fa-regular fa-square-plus"></i>
      </button>

      <%# Explore - only show if hashtags table exists %>
      <% if ActiveRecord::Base.connection.table_exists?(:hashtags) rescue false %>
        <%= link_to explore_path, class: "pf-nav-item #{'active' if controller_name == 'explore'}", title: "Explore" do %>
          <i class="fa-regular fa-compass"></i>
        <% end %>
      <% end %>

      <%# Notifications - with fallback for missing table %>
      <% notifications_enabled = ActiveRecord::Base.connection.table_exists?(:notifications) rescue false %>
      <% unread_count = notifications_enabled ? (current_user.notifications.unread.count rescue 0) : 0 %>
      <% recent_notifications = notifications_enabled ? (current_user.notifications.includes(actor: { profile_pic_attachment: :blob }).recent.limit(10) rescue []) : [] %>
      <div class="pf-nav-dropdown" data-controller="notifications">
        <button type="button" class="pf-nav-item" data-bs-toggle="dropdown" aria-expanded="false" title="Notifications">
          <i class="fa-regular fa-heart"></i>
          <span class="pf-notification-badge"
                data-notifications-target="badge"
                style="<%= unread_count == 0 ? 'display: none;' : '' %>">
            <%= unread_count > 99 ? '99+' : unread_count %>
          </span>
        </button>
        <div class="dropdown-menu pf-dropdown-menu pf-notifications-dropdown" data-notifications-target="dropdown">
          <div class="pf-dropdown-header">
            <h4>Notifications</h4>
            <% if notifications_enabled %>
              <%= link_to notifications_path, class: "pf-dropdown-link" do %>
                See All
              <% end %>
            <% end %>
          </div>
          <div class="pf-dropdown-body" data-notifications-target="list">
            <% if recent_notifications.any? %>
              <% recent_notifications.each do |notification| %>
                <div class="pf-notification-item <%= 'pf-notification-unread' unless notification.read? %>"
                     data-notification-id="<%= notification.id %>"
                     data-action="click->notifications#markAsRead"
                     data-notification-id="<%= notification.id %>">
                  <%= link_to user_path(notification.actor), class: "pf-notification-avatar" do %>
                    <% if notification.actor.profile_pic.attached? %>
                      <%= image_tag notification.actor.profile_pic, class: "pf-avatar pf-avatar-sm" %>
                    <% else %>
                      <%= image_tag 'user-pp.png', class: "pf-avatar pf-avatar-sm" %>
                    <% end %>
                  <% end %>
                  <div class="pf-notification-content">
                    <%= link_to notification.actor.username, user_path(notification.actor), class: "pf-notification-username" %>
                    <span class="pf-notification-text"><%= notification.message %></span>
                    <span class="pf-notification-time"><%= time_ago_in_words(notification.created_at) %></span>
                  </div>
                  <% if notification.action == 'follow_requested' %>
                    <div class="pf-notification-actions">
                      <%= button_to accept_follow_path(follow_id: notification.notifiable.id),
                          method: :post,
                          class: "pf-btn pf-btn-primary pf-btn-sm",
                          data: { turbo: false } do %>
                        Confirm
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="pf-empty-state">
                <i class="fa-regular fa-heart"></i>
                <p>No notifications yet</p>
              </div>
            <% end %>
          </div>
        </div>
        <span data-notifications-target="count" data-unread-count="<%= unread_count %>" style="display: none;"></span>
      </div>

      <%# Theme Toggle %>
      <button type="button"
              class="pf-nav-item pf-theme-toggle"
              data-action="click->theme#toggle"
              data-theme-target="toggle"
              title="Toggle theme">
        <i class="fa-solid fa-sun" data-theme-target="icon"></i>
      </button>

      <%# Profile Dropdown %>
      <div class="pf-nav-dropdown">
        <button type="button" class="pf-nav-item pf-nav-avatar" data-bs-toggle="dropdown" aria-expanded="false">
          <% if current_user.profile_pic.attached? %>
            <%= image_tag current_user.profile_pic, class: "pf-avatar pf-avatar-sm" %>
          <% else %>
            <%= image_tag 'user-pp.png', class: "pf-avatar pf-avatar-sm" %>
          <% end %>
        </button>
        <div class="dropdown-menu pf-dropdown-menu pf-profile-dropdown">
          <%= link_to user_path(current_user), class: "pf-dropdown-item" do %>
            <i class="fa-regular fa-user"></i>
            <span>Profile</span>
          <% end %>
          <%= link_to edit_user_registration_path, class: "pf-dropdown-item" do %>
            <i class="fa-solid fa-gear"></i>
            <span>Settings</span>
          <% end %>
          <div class="pf-dropdown-divider"></div>
          <%= button_to destroy_user_session_path, method: :delete, class: "pf-dropdown-item pf-dropdown-item-danger" do %>
            <i class="fa-solid fa-arrow-right-from-bracket"></i>
            <span>Log out</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</nav>

<%# Post Creation Modal %>
<%= render 'posts/form', post: Post.new %>
